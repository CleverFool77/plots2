<div class="like-buttons d-print-none btn-toolbar mb-3">
  <% if logged_in_as(['admin', 'moderator']) || (current_user && (current_user.uid == node.uid || node.has_tag("with:#{current_user.username}"))) %>
    <% if node.type == 'note' %>
      <a <% if current_user && current_user.uid != node.uid %>data-confirm='Please be aware that you are editing a post by another contributor, a privilege you have only because you are an admin or co-author.' <% end %> class='btn btn-outline-secondary btn-circle btn-sm' href='/notes/edit/<%= node.id %>?t=<%= Time.now.to_i %><% if params[:controller] == "questions" %>&redirect=question&template=question<% end %>'>
      <i class='ml-1 ff fa fa-pencil'></i>
      </a>
    <% end %>
  <% end %>

  <span data-toggle="tooltip" data-placement="top" rel="tooltip" title="Liked by <%= node.likers.length %> people" class="btn btn-outline-secondary btn-circle btn-like" node-id="<%= node.id %>" id="like-button-<%= node.id %>">
    <% if !current_user %>
      <a id="open-login-like" data-hashparams="like" data-toggle="modal" data-target="#loginModal">
        <span id="like-star-<%= node.id %>" class="ff fa fa-star"></span>
      </a>
    <% else %>
      <span id="like-star-<%= node.id %>" class="ff fa fa-star<% if !node.liked_by(current_user.uid) %>-o<% end %>"></span>
    <% end %>
  </span>

  <% if node %>
    <% subpage_count = Tag.find_pages("parent:#{node.slug}", 100).count %>
    <% if subpage_count > 0 %>
      <span class="btn btn-outline-secondary btn-circle" data-toggle="tooltip" data-placement="top" rel="tooltip" title="<%= subpage_count %> sub-pages">
        <a href="/wiki/tag/parent:<%= node.slug %>">
        <i class="ff fa fa-book"></i>
        </a>
      </span>
    <% end %>
  <% end %>
  <div class="dropdowna">
  <li id="ellipsis_sidebar" class="btn btn-outline-secondary btn-circle btn-sm" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      <span class="ml-2 ff fa fa-ellipsis-h" style="font-size: 1em;"></span>
    </li>
  <ul class="dropdown-menu">
    <li class="dropdown-item">
      <a href="/n/<%= node.id %>"><i class="fa fa-link"></i></a> <span class="d-none d-xl-inline"><a href="/n/<%= node.id %>">#<%= node.id %></a></span>
    </li>
    <div class="dropdown-divider"></div>
    <li class="dropdown-item">
      <a class="dropdown-item" href="#"><%= number_with_delimiter(node.views) %> <%= t('notes.show.views') %></a>
    </li>
    <li class="dropdown-item">
      <% if node.has_power_tag('question') %>
        <a class="dropdown-item" href="#answers"><%= node.answers.length %> answers</a>
      <% else %>
        <% if node.type == "note" %>
          <a class="dropdown-item" href="#comments"><%= node.comments.length %> <%= t('notes.show.comments') %></a>
        <% end %>
      <% end %> 
    </li>
    <li class="dropdown-item dropdown-submenu">
      <% if node.likers.length == 0 %>
        <a href="#" data-toggle="dropdown" class="dropdown-toggle">Users who liked this</a>
        <ul class="dropdown-menu users-menu">
          <li class="dropdown-item">
            <a href="#">None</a>
          </li>
        </ul>
      <% else %>
        <a href="#" data-toggle="dropdown" class="dropdown-toggle">Users who liked this</a>
        <ul class="dropdown-menu users-menu">
          <% node.likers.each do |user| %>
            <li class="dropdown-item">
              <a href='/profile/<%= user.username %>/'><%= user.username %></a>
            </li>
          <% end %>
        </ul>
      <% end %>
    </li>
    <% if (node.type == 'note' || node.has_power_tag('question')) && current_user && node.uid != current_user.uid %>
      <li class="dropdown-item dropdown-submenu">
        <a href="#" data-toggle="dropdown" class="dropdown-toggle">Award a barnstar</a>
        <ul class="dropdown-menu">
          <li class="dropdown-item">
            <a data-barnstar="basic" href="/barnstar/give?star=basic&nid=<%= node.id %>" >The basic barnstar</a>
          </li>
          <li class="dropdown-item">
            <a data-barnstar="photo-documentation" href="/barnstar/give?star=photo-documentation&nid=<%= node.id %>">The photo documentation barnstar</a>
          </li>
          <li class="dropdown-item">
            <a data-barnstar="video-documentation" href="/barnstar/give?star=video-documentation&nid=<%= node.id %>">The video documentation barnstar</a>
          </li>
          <li class="dropdown-item">
            <a data-barnstar="watchdog" href="/barnstar/give?star=watchdog&nid=<%= node.id %>">The watchdog barnstar</a>
          </li>
          <li class="dropdown-item">
            <a data-barnstar="empiricism" href="/barnstar/give?star=empiricism&nid=<%= node.id %>">The empiricism barnstar</a>
          </li>
          <li class="dropdown-item">
            <a data-barnstar="excessive-enthusiasm" href="/barnstar/give?star=excessive-enthusiasm&nid=<%= node.id %>">The enthusiasm barnstar</a>
          </li>
        </ul>
      </li>
    <% end %>
    <% if logged_in_as(['admin', 'moderator']) || (current_user && current_user.uid == node.uid) %>
      <% if node.type == 'note' || node.has_power_tag('question') %>
        <li class="dropdown-item">
          <a rel='tooltip' title='Flag as spam' class='dropdown-item btn btn-sm btn-outline-secondary btn-flag-spam-<%= node.id %>' href='mailto:moderators@publiclab.org?subject=Reporting+spam+on+Public+Lab&body=Hi,+I+found+this+item+that+looks+like+spam+or+needs+to+be+moderated:+<%= node.title.gsub(/ /,'+') %>+https://publiclab.org/n/<%= node.id %>+by+https://publiclab.org/profile/<%= node.author.username %>+Thanks!'>
            Flag as Spam
          </a>
        </li>
        <li class="dropdown-item">
          <a href='/notes/delete/<%= node.id %>' class='dropdown-item btn btn-outline-secondary btn-sm' data-confirm='Are you sure?'>
            <i class='fa fa-trash'></i> Delete
          </a>
        </li>
        <li class="dropdown-item">
          <a href='/notes/raw/<%= node.id %>' class='dropdown-item btn btn-outline-secondary btn-sm'>
            <i class='fa fa-code'></i> Raw
          </a>
        </li>
      <% end %>
      <% if logged_in_as(['admin', 'moderator']) %>
          <% if node.type == 'note' %>
            <li class="dropdown-item">
              <a class='dropdown-item btn btn-outline-secondary btn-sm' href='/moderate/spam/<%= node.id %>'><i class='fa fa-ban-circle'></i> Spam</a>
            </li>
          <% elsif node.type == 'page' %>
            <li class="dropdown-item">
              <a class='dropdown-item btn btn-outline-secondary btn-sm' href='/moderate/revision/spam/<%= @revision.vid %>'><i class='fa fa-ban-circle'></i> Spam revision</a>
            </li>
          <% end %>
      <% end %>
    <% end %>
      <li class="dropdown-item">
        <a id='print-command-no-links'><i class='fa fa-print'></i>Print without page links</a>
      </li>
      <li class="dropdown-item">
        <a id='print-command-3-col'><i class='fa fa-print'></i> Print in 3-column layout</a>
      </li>
    <div class="dropdown-divider"></div>
    <li class="dropdown-item">
      <a><%= node.created_at.to_s(:long) %></a>
    </li>
  </ul>
</div>

  <style type="text/css">
    /* Styling the links to remove underline on hover and setting pointer as cursor */
    #print-command-3-col , #print-command-no-links {
      text-decoration : none;
      cursor : pointer;
    }
    .bs-popover-bottom {
    	overflow: visible;
    	max-width: 1000px;
    }
    .like-buttons {
      margin-top:5px;
    }
    @media (max-width: 992px) {
      .like-buttons {
        justify-content: center !important;
        margin-top: 30px;
      }
    }
  </style>

  <script>
    $('[rel="tooltip"]').on('click', function () {
        $(this).tooltip('hide')
    })
    function print_three_column() {
      $('body').css('column-count', 3)
               .css('column-gap', '50px');
      $('.popover').popover('hide');
      window.print();
      $('body').css('column-count', 1)
               .css('column-gap', 0);
    }
    // Event listner on CLICK on links
    $(document).on("click", "#print-command-3-col",print_three_column);
    $(document).on("click", "#print-command-no-links",print_linkless);
    jQuery(document).ready(function() {
      // 304 cached response yields no data to insert, which is not useful
      jQuery.ajaxSetup({
        cache: false
      });
      // opens modal to login before you can like;
      $("#open-login-like").click(function() {
        $("input[name='hash_params']").val($(this).attr("data-hashparams"));
      });
      // triggers liking and unliking
      <% if current_user %>
        $('#like-button-<%= node.id %>').on('click', debounce(<% if node.liked_by(current_user.uid) %>clickliked<% else %>clicknotliked<% end %>, 200, true));
        // leaving below uncommented for now - possibility useful for implement comment like functionality?
        // if(window.location.href.includes("#like")) {
        //   $('#like-button-<%= node.id %>').click();
        // }
      <% end %>
    });
    $('body').on('click', '.nestedPopover', function() {
      $(this).popover({
        container: 'body',
        trigger: 'focus click'
      });
      $(this).popover('show');
      $(this).removeClass("nestedPopover");
    });
    $('body').on('click', function (e) { // If there's a click event in the body
      $('[rel=popover]').each(function () { // For each popover
        /*
        * The popover will only `hide` if all the conditions below are satisfied :
        * 1. The target triggering the `click` event is not `this`
        * 2. `this` doesn't have a child triggering the `click` event
        * 3. Any element with `.popover` class doesn't have a child triggering the `click` event
        */
        if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0) {
          $(this).popover('hide');
        }
      });
    });

    $('.dropdown-submenu > a').on("click", function(e) {
      var submenu = $(this);
      console.log(submenu);
      $('.dropdown-submenu .dropdown-menu').removeClass('show');
      submenu.next('.dropdown-menu').addClass('show');
      e.stopPropagation();
    });

    $('.dropdowna').on("hidden.bs.dropdown", function() {
        // hide any open menus when parent closes
        $('.dropdown-menu.show').removeClass('show');
    });


  </script>
</div>

<style>
.dropdown-submenu {
  position: relative;
}

.dropdown-submenu .dropdown-menu {
  top: 0;
  left: -126%;
  margin-top: 2px;
}

.dropdown-submenu .users-menu {
  top: 0;
  left: -69%;
  margin-top: 2px;
}

.dropdowna li a {
  padding-left: 0px;
}

.dropdowna {
  z-index: 100000 !important;
}
    
.btn-circle {
  height: 45px;
  width: 45px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  margin-right: 5px;
  border-color: #ccc;
}

.ff {
  font-size: 1.5em;
}

</style>
